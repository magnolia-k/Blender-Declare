#!/usr/bin/perl

use 5.012;
use warnings;

use version;

use FindBin;
use lib "$FindBin::Bin/../lib/perl5";

require Blender::Home;
Blender::Home->initialize;

my $target = shift @ARGV;
my $condition = shift @ARGV;

unless ( $target ) {
    die "you must set target name parameter";
}

if ( $target =~ /[^a-z0-9]/ ) {
    die( Blender::Error->new( "invalid target name '$target'" ));
}

my $module = 'Blender::Definition::' . ucfirst( $target );

require Blender::Require;
eval { Blender::Require->try_require( $module ) };

if ( $@ ) {
    die( Blender::Error->new( "no definition for target '$target'" ));
}

my $attributes = $module->new->parse;

if ( $condition ) {
    $attributes->add( 'VersionCondition', $condition );
} else {
    $attributes->add( 'VersionCondition' );
}


my @list = qw/
AdditionalArgument
AllowedCondition
ArchiveName
Dependencies
DistName
DownloadSite
Extension
Filename
IndexParserForm
IndexSite
PatchFiles
Prefix
URL
Version
VersionList
VersionCondition
VersionForm
WebSite
CommandConfigure
CommandMake
CommandTest
CommandInstall
/;

print "target:" . $target . "\n";
print "\n";

foreach my $name ( sort @list ) {

    my $value = $attributes->$name;

    print $name . ':';

    if ( ! $value ) {
        print "\n";
        next;
    }

    if ( ! ref( $value ) ) {
        print $value . "\n";
        next;
    }

    if ( ref( $value ) eq 'ARRAY' && $name ne 'VersionList' ) {
        print "\n";

        foreach my $val ( sort @{ $value } ) {
            print "    ";
            print $val . "\n";
        }

        next;
    }

    if ( $name eq 'VersionList' ) {
        print "\n";

        foreach my $val ( sort {
                version->declare( $a ) cmp version->declare( $b)
                } @{ $value } ) {

            print "    ";
            print $val . "\n";
        }

        next;
 
    }

}   
